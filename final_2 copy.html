<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>D3 Template</title>

    <style>
      /* CSS Graphic Styles go here */
    </style>

    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script type="text/javascript">
      allDates = [
        "2020-02-24",
        "2020-02-25",
        "2020-02-26",
        "2020-02-27",
        "2020-02-28",
        "2020-02-29",
        "2020-03-01",
        "2020-03-02",
        "2020-03-03",
        "2020-03-04",
        "2020-03-05",
        "2020-03-06",
        "2020-03-07",
        "2020-03-08",
        "2020-03-09",
        "2020-03-10",
        "2020-03-11",
        "2020-03-12",
        "2020-03-13",
        "2020-03-14",
        "2020-03-15",
        "2020-03-16",
        "2020-03-17",
        "2020-03-18",
        "2020-03-19",
        "2020-03-20",
        "2020-03-21",
        "2020-03-22",
        "2020-03-23",
        "2020-03-24",
        "2020-03-25",
        "2020-03-26",
        "2020-03-27",
        "2020-03-28",
        "2020-03-29",
        "2020-03-30",
        "2020-03-31",
        "2020-04-01",
        "2020-04-02",
        "2020-04-03",
        "2020-04-04",
        "2020-04-05",
        "2020-04-06",
        "2020-04-07",
        "2020-04-08",
        "2020-04-09",
        "2020-04-10",
        "2020-04-11",
        "2020-04-12",
        "2020-04-13",
        "2020-04-14",
        "2020-04-15",
        "2020-04-16",
        "2020-04-17",
        "2020-04-18",
        "2020-04-19",
        "2020-04-20",
        "2020-04-21",
        "2020-04-22",
        "2020-04-23",
        "2020-04-24",
        "2020-04-25",
        "2020-04-26",
        "2020-04-27",
        "2020-04-28",
        "2020-04-29",
        "2020-04-30",
        "2020-05-01",
        "2020-05-02",
        "2020-05-03",
        "2020-05-04",
        "2020-05-05",
        "2020-05-06",
        "2020-05-07",
        "2020-05-08",
        "2020-05-09",
        "2020-05-10",
        "2020-05-11",
        "2020-05-12",
        "2020-05-13",
        "2020-05-14",
        "2020-05-15",
        "2020-05-16",
        "2020-05-17",
        "2020-05-18",
        "2020-05-19",
        "2020-05-20",
        "2020-05-21",
        "2020-05-22",
        "2020-05-23",
        "2020-05-24",
        "2020-05-25",
        "2020-05-26",
        "2020-05-27",
        "2020-05-28",
        "2020-05-29",
        "2020-05-30",
        "2020-05-31",
        "2020-06-01",
        "2020-06-02",
        "2020-06-03",
        "2020-06-04",
        "2020-06-05",
        "2020-06-06",
        "2020-06-07",
        "2020-06-08",
        "2020-06-09",
        "2020-06-10",
        "2020-06-11",
        "2020-06-12",
        "2020-06-13",
        "2020-06-14",
        "2020-06-15",
        "2020-06-16",
        "2020-06-17",
        "2020-06-18",
        "2020-06-19",
        "2020-06-20",
        "2020-06-21",
        "2020-06-22",
        "2020-06-23",
        "2020-06-24",
        "2020-06-25",
        "2020-06-26",
        "2020-06-27",
        "2020-06-28",
        "2020-06-29",
        "2020-06-30",
        "2020-07-01",
        "2020-07-02",
        "2020-07-03",
        "2020-07-04",
        "2020-07-05",
        "2020-07-06",
        "2020-07-07",
        "2020-07-08",
        "2020-07-09",
        "2020-07-10",
        "2020-07-11",
        "2020-07-12",
        "2020-07-13",
        "2020-07-14",
        "2020-07-15",
        "2020-07-16",
        "2020-07-17",
        "2020-07-18",
        "2020-07-19",
        "2020-07-20",
        "2020-07-21",
        "2020-07-22",
        "2020-07-23",
        "2020-07-24",
        "2020-07-25",
        "2020-07-26",
        "2020-07-27",
        "2020-07-28",
        "2020-07-29",
        "2020-07-30",
        "2020-07-31",
        "2020-08-01",
        "2020-08-02",
        "2020-08-03",
        "2020-08-04",
        "2020-08-05",
        "2020-08-06",
        "2020-08-07",
        "2020-08-08",
        "2020-08-09",
        "2020-08-10",
        "2020-08-11",
        "2020-08-12",
        "2020-08-13",
        "2020-08-14",
        "2020-08-15",
        "2020-08-16",
        "2020-08-17",
        "2020-08-18",
        "2020-08-19",
        "2020-08-20",
        "2020-08-21",
        "2020-08-22",
        "2020-08-23",
        "2020-08-24",
        "2020-08-25",
        "2020-08-26",
        "2020-08-27",
        "2020-08-28",
        "2020-08-29",
        "2020-08-30",
        "2020-08-31",
        "2020-09-01",
        "2020-09-02",
        "2020-09-03",
        "2020-09-04",
        "2020-09-05",
        "2020-09-06",
        "2020-09-07",
        "2020-09-08",
        "2020-09-09",
        "2020-09-10",
        "2020-09-11",
        "2020-09-12",
        "2020-09-13",
        "2020-09-14",
        "2020-09-15",
        "2020-09-16",
        "2020-09-17",
        "2020-09-18",
        "2020-09-19",
        "2020-09-20",
        "2020-09-21",
        "2020-09-22",
        "2020-09-23",
        "2020-09-24",
        "2020-09-25",
        "2020-09-26",
        "2020-09-27",
        "2020-09-28",
        "2020-09-29",
        "2020-09-30",
        "2020-10-01",
        "2020-10-02",
        "2020-10-03",
        "2020-10-04",
        "2020-10-05",
        "2020-10-06",
        "2020-10-07",
        "2020-10-08",
        "2020-10-09",
        "2020-10-10",
        "2020-10-11",
        "2020-10-12",
        "2020-10-13",
        "2020-10-14",
        "2020-10-15",
        "2020-10-16",
        "2020-10-17",
        "2020-10-18",
        "2020-10-19",
        "2020-10-20",
        "2020-10-21",
        "2020-10-22",
        "2020-10-23",
        "2020-10-24",
        "2020-10-25",
        "2020-10-26",
        "2020-10-27",
        "2020-10-28",
        "2020-10-29",
        "2020-10-30",
        "2020-10-31",
        "2020-11-01",
        "2020-11-02",
        "2020-11-03",
        "2020-11-04",
        "2020-11-05",
        "2020-11-06",
        "2020-11-07",
        "2020-11-08",
        "2020-11-09",
        "2020-11-10",
        "2020-11-11",
        "2020-11-12",
        "2020-11-13",
        "2020-11-14",
        "2020-11-15",
        "2020-11-16",
        "2020-11-17",
        "2020-11-18",
        "2020-11-19",
        "2020-11-20",
        "2020-11-21",
        "2020-11-22",
        "2020-11-23",
        "2020-11-24",
        "2020-11-25",
        "2020-11-26",
        "2020-11-27",
        "2020-11-28",
        "2020-11-29",
        "2020-11-30",
        "2020-12-01",
        "2020-12-02",
        "2020-12-03",
        "2020-12-04",
        "2020-12-05",
        "2020-12-06",
        "2020-12-07",
        "2020-12-08",
        "2020-12-09",
        "2020-12-10",
        "2020-12-11",
        "2020-12-12",
        "2020-12-13",
        "2020-12-14",
        "2020-12-15",
        "2020-12-16",
        "2020-12-17",
        "2020-12-18",
        "2020-12-19",
        "2020-12-20",
        "2020-12-21",
        "2020-12-22",
        "2020-12-23",
        "2020-12-24",
        "2020-12-25",
        "2020-12-26",
        "2020-12-27",
        "2020-12-28",
        "2020-12-29",
        "2020-12-30",
        "2020-12-31",
        "2021-01-01",
        "2021-01-02",
        "2021-01-03",
        "2021-01-04",
        "2021-01-05",
        "2021-01-06",
        "2021-01-07",
        "2021-01-08",
        "2021-01-09",
        "2021-01-10",
        "2021-01-11",
        "2021-01-12",
        "2021-01-13",
        "2021-01-14",
        "2021-01-15",
        "2021-01-16",
        "2021-01-17",
        "2021-01-18",
        "2021-01-19",
        "2021-01-20",
        "2021-01-21",
        "2021-01-22",
        "2021-01-23",
        "2021-01-24",
        "2021-01-25",
        "2021-01-26",
        "2021-01-27",
        "2021-01-28",
        "2021-01-29",
        "2021-01-30",
        "2021-01-31",
        "2021-02-01",
        "2021-02-02",
        "2021-02-03",
        "2021-02-04",
        "2021-02-05",
        "2021-02-06",
        "2021-02-07",
        "2021-02-08",
        "2021-02-09",
        "2021-02-10",
        "2021-02-11",
        "2021-02-12",
        "2021-02-13",
        "2021-02-14",
        "2021-02-15",
        "2021-02-16",
        "2021-02-17",
        "2021-02-18",
        "2021-02-19",
        "2021-02-20",
        "2021-02-21",
        "2021-02-22",
        "2021-02-23",
        "2021-02-24",
        "2021-02-25",
        "2021-02-26",
        "2021-02-27",
        "2021-02-28",
        "2021-03-01",
        "2021-03-02",
        "2021-03-03",
        "2021-03-04",
        "2021-03-05",
        "2021-03-06",
        "2021-03-07",
        "2021-03-08",
        "2021-03-09",
        "2021-03-10",
        "2021-03-11",
        "2021-03-12",
        "2021-03-13",
        "2021-03-14",
        "2021-03-15",
        "2021-03-16",
        "2021-03-17",
        "2021-03-18",
        "2021-03-19",
        "2021-03-20",
        "2021-03-21",
        "2021-03-22",
        "2021-03-23",
        "2021-03-24",
        "2021-03-25",
        "2021-03-26",
        "2021-03-27",
        "2021-03-28",
        "2021-03-29",
        "2021-03-30",
        "2021-03-31",
        "2021-04-01",
        "2021-04-02",
        "2021-04-03",
        "2021-04-04",
        "2021-04-05",
        "2021-04-06",
        "2020-02-13",
        "2020-02-14",
        "2020-02-15",
        "2020-02-16",
        "2020-02-17",
        "2020-02-18",
        "2020-02-19",
        "2020-02-20",
        "2020-02-21",
        "2020-02-22",
        "2020-02-23",
        "2020-01-01",
        "2020-01-02",
        "2020-01-03",
        "2020-01-04",
        "2020-01-05",
        "2020-01-06",
        "2020-01-07",
        "2020-01-08",
        "2020-01-09",
        "2020-01-10",
        "2020-01-11",
        "2020-01-12",
        "2020-01-13",
        "2020-01-14",
        "2020-01-15",
        "2020-01-16",
        "2020-01-17",
        "2020-01-18",
        "2020-01-19",
        "2020-01-20",
        "2020-01-21",
        "2020-01-22",
        "2020-01-23",
        "2020-01-24",
        "2020-01-25",
        "2020-01-26",
        "2020-01-27",
        "2020-01-28",
        "2020-01-29",
        "2020-01-30",
        "2020-01-31",
        "2020-02-01",
        "2020-02-02",
        "2020-02-03",
        "2020-02-04",
        "2020-02-05",
        "2020-02-06",
        "2020-02-07",
        "2020-02-08",
        "2020-02-09",
        "2020-02-10",
        "2020-02-11",
        "2020-02-12",
      ];
      /* variables, javascript and D3 functions go here */
      var data; // define a container variable to hold your data
      var dates;
      var selectedDateIndex = 0;
      var selectedDates = [];
      var simulation;
      width = 1500;
      height = 1500;
      baselineX = width / 2;
      baselineY = height / 2;
      ringRadius = baselineX * 0.8;
      sortByDateAscending = (a, b) => {
        // Dates will be cast to numbers automagically:
        return a.dateObj - b.dateObj;
      };
      parseDateData = (date) => {
        values = date[1];
        valueDates = values.map((item) => item.date);
        addedDates = allDates.reduce((acc, item) => {
          if (!valueDates.includes(item)) {
            return [...acc, { date: item, location: date[0], isNull: true }];
          }
          return acc;
        }, []);
        combined = [...date[1], ...addedDates];
        combined = combined.map((data) => ({
          ...data,
          dateObj: new Date(data.date),
        }));
        combined = combined.sort(sortByDateAscending);
        return { key: date[0], value: combined };
      };
      getData = () => {
        d3.csv(
          "https://raw.githubusercontent.com/taylorrohrich/data_viz_final_project/main/data/parsed.csv"
        ).then((csvdata) => {
          // rawData = csvdata;
          // dates =d3.map(data, function(d){return d.roadname;}).keys()
          data = d3.group(csvdata, (d) => d["location"]);
          data = d3.map(data, parseDateData);
          draw();
        });
      };
      getCoordinates = (angle, radius) => {
        x = Math.cos(angle) * radius;
        y = Math.sin(angle) * radius;
        return [x, y];
      };

      getAnchorPoints = () => {
        let pi = Math.PI;
        anchorPoints = [];
        startingPoint = Math.PI / 2;
        for (i = 0; i < 10; i++) {
          anchorPoints.push(startingPoint);
          startingPoint -= (2 * pi) / 10;
        }
        return anchorPoints;
      };
      anchorPointCoords = getAnchorPoints()
        .map((angle) => getCoordinates(angle, baselineX * 0.8))
        .map((coords) => [baselineX + coords[0], baselineY - coords[1]]);
      getSize = (point) => {
        if (point.isNull) return 1;
        return 5 + Math.sqrt(Number(point.new_cases_smoothed_per_million));
      };
      getOpacity = (point) => (!point.isNull ? 1 : 0.1);
      getForceCenter = (point) => {
        let pi = Math.PI;
        const center = [baselineX, baselineY];
        if (!point.isNull) {
          vacc = Math.ceil(Number(point.people_vaccinated_per_hundred)) / 100;
          if (vacc == 0) return [center[0], center[1]];
          angle = pi / 2 - 2 * pi * vacc;
          coords = getCoordinates(angle, ringRadius);
          return [baselineX + coords[0], baselineY - coords[1]];
        }
        return [center[0], center[1]];
      };
      getFill = (point) => (!point.isNull ? "#e3e3e3" : "#ff5555");
      draw = () => {
        console.log(data);
        var svg = d3.select("#viz");
        svg
          .append("circle")
          .attr("cx", baselineX)
          .attr("cy", baselineY)
          .attr("r", baselineX * 0.8)
          .attr("stroke", "#e3e3e3")
          .attr("fill", "#ffffff");
        svg
          .selectAll(".anchorPoints")
          .data(anchorPointCoords)
          .join("circle")
          .attr("cx", (d) => d[0])
          .attr("cy", (d) => d[1])
          .attr("r", 10)
          .attr("stroke", "#e3e3e3")
          .attr("fill", "#ffffff");
        var simulation = d3
          .forceSimulation()
          //   .force("charge", d3.forceManyBody().strength(0.2))
          // .force("center", d3.forceCenter(baselineX, baselineY))
          .force(
            "x",
            d3.forceX((d) => getForceCenter(d.value[selectedDateIndex])[0])
          )
          .force(
            "y",
            d3.forceY((d) => getForceCenter(d.value[selectedDateIndex])[1])
          )
          .force(
            "collide",
            d3.forceCollide().radius((d) => getSize(d.value[selectedDateIndex]))
          )
          .force("charge", d3.forceManyBody().strength(0.1));
        var bubbles = svg
          .selectAll(".points")
          .data(data)
          .enter()
          .append("circle")
          .attr("r", (d) => getSize(d.value[selectedDateIndex]))
          .attr("fill", (d) => getFill(d.value[selectedDateIndex]))
          .attr("fill-opacity", (d) => getOpacity(d.value[selectedDateIndex]));

        simulation.nodes(data).on("tick", ticked);

        function ticked() {
          bubbles
            .attr("cx", function (d) {
              return d.x;
            })
            .attr("cy", function (d) {
              return d.y;
            });
        }
        d3.interval(
          function () {
            selectedDateIndex += 5;
            simulation.alpha(0.5).alphaTarget(0.3).restart();

            simulation.force("x").initialize(data);
            simulation.force("y").initialize(data);
            simulation.force("collide").initialize(data);
            bubbles
              .transition()
              .duration(200)
              .attr("r", (d) => getSize(d.value[selectedDateIndex]))
              .attr("fill-opacity", (d) =>
                getOpacity(d.value[selectedDateIndex])
              )
              .attr("fill", (d) => getFill(d.value[selectedDateIndex]));
            //   .attr("fill", function (d) {
            //     return colorScale(d[year]);
            //   });
          },
          500,
          d3.now()
        );
      };
    </script>
  </head>
  <body onload="getData()">
    <svg id="viz" width="1500" height="1500"></svg>
  </body>
</html>
